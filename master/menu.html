<!DOCTYPE HTML>
<html lang="en-US">

<head>
	<meta charset="UTF-8">
	<link rel="apple-touch-icon" href="" />
	<link rel="apple-touch-startup-image" href="">
	<meta name="apple-mobile-web-app-title" content="Game Party">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	<title>Game Party</title>


	<!--INCLUDE ANY LIBRARIES HERE SO THAT THEY CAN BE LOADED AT FIRST, THEN SHARED -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
	<script type="text/javascript" src="assets/libraries/GameResult.js"></script>

	<!--INCLUDE GAMES HERE -->
	<script type "text/javascript" src="games/game/game.js"></script>
	<script type "text/javascript" src="games/pong/pong.js"></script>
	<script type "text/javascript" src="games/ticTacToe/ticTacToe.js"></script>
	<script type "text/javascript" src="games/compBlock/compBlock.js"></script>
	<script type "text/javascript" src="games/virtualDDR/virtualDDR.js"></script>
	<script type "text/javascript" src="games/runningMan/runningMan.js"></script>
	<script type "text/javascript" src="games/pastryPanic/pastryPanic.js"></script>
	<script type "text/javascript" src="games/monsterBattle/monsterBattle.js"></script>
	<script type "text/javascript" src="games/miniGolf/miniGolf.js"></script>


	<script type="text/javascript">
		$(document).ready(function () {
			//Initial Jquery Statements to hide needed divs
			$("#startGame").hide();
			$("#pleaseWait").hide();
			$("#waitingPeers").hide();


			//Define click events for clicking button to join Game
			$("#nzupjvjyjnx3l3di1").click(function () {
				createRoom("nzupjvjyjnx3l3di");
			});
			$("#qtel6mk2t1chm2t91").click(function () {
				createRoom("qtel6mk2t1chm2t9");
			});
			$("#fq6a4niiuzkhuxr1").click(function () {
				createRoom("fq6a4niiuzkhuxr");
			});
			$("#jml9r8bsz1714i1").click(function () {
				createRoom("jml9r8bsz1714i");
			});
			$("#fuszgluehi8p8pvi1").click(function () {
				createRoom("fuszgluehi8p8pvi");
			});
			$("#dvy4sjbvks79o1or1").click(function () {
				createRoom("dvy4sjbvks79o1or");
			});
			$("#gx8uncxet3s1yvi1").click(function () {
				createRoom("gx8uncxet3s1yvi");
			});
			$("#l0wew8sguzo205291").click(function () {
				createRoom("l0wew8sguzo20529");
			});
			$("#nzupjvjyjnx3l3di2").click(function () {
				joinRoom("nzupjvjyjnx3l3di");
			});
			$("#qtel6mk2t1chm2t92").click(function () {
				joinRoom("qtel6mk2t1chm2t9");
			});
			$("#fq6a4niiuzkhuxr2").click(function () {
				joinRoom("fq6a4niiuzkhuxr");
			});
			$("#jml9r8bsz1714i2").click(function () {
				joinRoom("jml9r8bsz1714i");
			});
			$("#fuszgluehi8p8pvi2").click(function () {
				joinRoom("fuszgluehi8p8pvi");
			});
			$("#dvy4sjbvks79o1or2").click(function () {
				joinRoom("dvy4sjbvks79o1or");
			});
			$("#gx8uncxet3s1yvi2").click(function () {
				joinRoom("gx8uncxet3s1yvi");
			});
			$("#l0wew8sguzo205292").click(function () {
				joinRoom("l0wew8sguzo20529");
			});

			/**Setup Connections
			 * This method will handle setting up the connection object to run the required data receiving methods. This will require 
			 * a common method of transmitting data across the project. To setup a data receiver, add a conn.on method or add to this
			 * method that will work to receive an array of two objects (standard), or more objects (nonstandard). The important
			 * part here is that data is sent as an array. The first array entry should be a string identifier for what the programmer
			 * wants to happen when that data is received. Otherwise, setting up more than one data connection would duplicate and perform
			 * more than the desired actions
			 * 
			 * Data connection format
			 * 		data >>> ["String Identifier for Case break", DATAOBJECT_SENT]
			 * 
			 */
			function setupConn(conn) {
				var miniGameResults = new Array(50);
				//for (i = 0; i < 50; i++) {
				//	miniGameResults[i] = new GameResult(0, 0, "");
				//}
				conn.on('data', function (data) {
					console.log("Received to Datacontroller: " + data[0]);
					switch (data[0]) {
						//Various Cases for the first element of data being passed 
						case "#sendID_1":
							console.log("Interpreted received data as #send_id");
							break;

							//Run game signal to player 2
						case "#sendID_p1startGametop2":
							conn.send("Player 2 Listener received message to run game");
							$("#pleaseWait").slideUp();
							runGameAsGuest(data, this.connection);
							break;

							//TestData - used to demonstrate the functionality of this
						case "#test1":
							alert("Test has been completed");
							console.log("This is a test function and signals that a test connection has been attempted");
							console.log(data[1]);
							break;

							//Used to listen on the player 2 side. Player one will call this data connection to signal the beginning
							//of a new game. Player two will receive this and run that game. Note that the sync process will be ran
							//in the beginning of the game. 

						case "runP2game":
							console.log("Player 2 listener has received a request to run a game " + data[1]);
							$("#pleaseWait").slideUp();
							//miniGameResults[i] = runMiniGame(data[1], conn);
							break;


							//This will signal the end of the game sequence to player 2. Player one will pass the existing game 
							//results data to player 2;
						case "signalP2end":
							console.log("A signal has been received to end the game sequence");
							//displayResults(miniGameResults);
							break;


							//End the current minigame to move on to other minigame or menu
						case "signalP2gameOver":
							console.log("A signal has been received to end the current minigame");
							break;

							//Signal from player 2 to player one which will send a welcome message initiating the game 
						case "signalP1connected":
							console.log("A message has been received from a joined player showing successful connection...\n" + data[1]);
							$("#startGame").slideDown();
							$("#startGame").click(function () {
								$("#startGame").slideUp();
								runGameAsHost(1, conn);
							});
							break;

						default:
							console.error(
								"Data was sent to the data controller via conn.send, but there was no case setup to handle the data array identifier for data[0]. Ensure that you are sending data via an array where data[0] is a string identifier that has been defined in a data controller which will direct the data flow. "
							);
							console.error("Unhandled data[0] data: " + data[0]);
							console.error("Unhandled data: " + data);
					}

				});
				return conn;
			}


			function runMiniGame(gameName, conn, miniGameResult) {
				console.log("Searching to link game: " + gameName);
				miniGameResult = new GameResult(0, 0, "");
				switch (gameName) {
					case "TicTacToe":
						newGame = new TicTacToe(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "Pong":
						newGame = new Pong(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "Game":
						newGame = new MiniGameName(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "CompBlock":
						newGame = new CompBlock(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "MiniGolf":
						newGame = new MiniGolf(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "MonsterBattle":
						newGame = new MonsterBattle(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "PastryPanic":
						newGame = new PastryPanic(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "RunningMan":
						newGame = new RunningMan(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
					case "VirtualDDR":
						newGame = new VirtualDDR(conn, playerNumber);
						miniGameResult = newGame.runGame();
						break;
				}
				return miniGameResult;
			}



			/*
			The way to fix this would be to keep a timestamp variable as a timeout variable. Say 
			that IF a connection is not made via the conn.on.open within 5 seconds, it will simply 
			create the room rather than try to join. This would be rather easy to implement
			*/
			function joinRoom(apiKey) {
				this.connection;

				console.log("Attempting to join room " + apiKey);
				var connectedRoom = false;
				peer = new Peer({
					key: apiKey
				});

				peer.on("open", function (id) {
					pid = id;
				});
				conn = peer.connect(apiKey);
				conn.on("open", function () {
					$("#pleaseWait").slideDown();
					$("#gameTable").slideUp();
					console.log("Initiated Connection");
					conn.send(["signalP1connected", "I'm here and ready to play now"]);
					this.connection = conn;
					connected = true;
					playerNumber = 2;
					conn = setupConn(conn);
				});

			}

			function createRoom(apiKey) {
				$("#gameTable").slideUp();
				$("#waitingPeers").slideDown();
				console.log("Creating room " + apiKey);
				var timeOut;

				peer = new Peer(apiKey, {
					key: apiKey
				});
				console.log("Waiting for connection");
				peer.on("connection", function (conn) {
					conn = setupConn(conn);
					//Listening on 'signalP1connected'
					playerNumber = 1;
					console.log("Received Connection");
				});

			}



			function displayResults(miniGameResults) {
				console.log("GAME OVER!");
				var outString = "End of Game Summary\n";
				for (i = 0; i < miniGameResults.length; i++) {
					outString += miniGameResults.toString();
				}
				alert(outString);
			}

			function determineGame(miniGames) {
				var chosenGame = 0;
				var validGame = false;
				while (validGame == false) {
					validGame = false;
					chosenGame = Math.floor(Math.random() * miniGames.length);
					var initialChosen = chosenGame;
					while (validGame == false) {
						if (miniGames[chosenGame] != "USEDGAME") {
							validGame = true;

						} else {

							if (chosenGame >= miniGames.length) {
								chosenGame = 0;
							} else if (chosenGame = initialChosen) {
								return -1;
							}
							chosenGame++;
						}
					}
				}
				console.log("Chose Game Number: " + chosenGame);
				return chosenGame;
			}

			function runGameAsHost(numberRounds, conn) {
				//var miniGames = ["TicTacToe", "Pong", "Game", "CompBlock", "MiniGolf", "MonsterBattle", "PastryPanic",
				//	"RunningMan", "VirtualDDR"
				//];
				var miniGames = ["Game"];
				var miniGameResults = new Array(miniGames.length);
				for (i = 0; i < miniGames.length; i++) {
					miniGameResults[i] = new GameResult(0, 0, "");
				}
				var playerNumber = -1;
				var keepGoing = true;
				var currentRound = 0;
				var maxRounds = miniGames.length;
				var keepGoing = true;
				var chosenGame = 0;
				for (i = 0; i < numberRounds; i++) {
					console.log("Running Game Controller as host Round: " + i);
					chosenGame = determineGame(miniGames)


					if (chosenGame != -1) {
						console.log("Sharing chosen game with peer");
						conn.send(["runP2game", miniGames[chosenGame]]);
						miniGameResults[i] = runMiniGame(miniGames[chosenGame], conn);
						miniGames[chosenGame] = "USEDGAME";
					} else if (i >= maxRounds) {
						i += 100;
					} else {
						i += 100;
					}
				}
				conn.send(["signalP2end", ""]);
				displayResults(miniGameResults);

			}

		});
	</script>













	<style type="text/css">
		table,
		th,
		td {
			border: 1px solid black;
		}
	</style>
</head>

<body>
	<h1>Game Lobby ----- USE MELON JS</h1>
	<div id="pleaseWait">
		<h2>Please Wait!</h2>
		<p>The host of this game has been notified of your arrival and the game will start when they choose</p>
	</div>
	<div id="waitingPeers">
		<h2>Waiting for Peer</h2>
		<p>You have started a session but no peers have joined. When they join you will be notified and will be able to start the
			game via a button click.</p>
	</div>
	<button id="startGame">Another player has joined. Click here to start the game.</button>
	<div id="gameTable">
		<table>
			<tr>
				<th>Game Name</th>
				<th>API Key</th>
				<th>Enter Game P1</th>
				<th>Enter Game P2</th>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 1
				</td>
				<td class="gameAPITable">
					nzupjvjyjnx3l3di
				</td>
				<td>
					<button id="nzupjvjyjnx3l3di1">Create Game as Player 1</button>
				</td>
				<td>
					<button id="nzupjvjyjnx3l3di2">Join Game as Player 2</button>
				</td>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 2
				</td>
				<td class="gameAPITable">
					qtel6mk2t1chm2t9
				</td>
				<td>
					<button id="qtel6mk2t1chm2t91">Create Game as Player 1</button>
				</td>
				<td>
					<button id="qtel6mk2t1chm2t92">Join Game as Player 2</button>
				</td>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 3
				</td>
				<td class="gameAPITable">
					fq6a4niiuzkhuxr
				</td>
				<td>
					<button id="fq6a4niiuzkhuxr1">Create Game as Player 1</button>
				</td>
				<td>
					<button id="fq6a4niiuzkhuxr2">Join Game as Player 2</button>
				</td>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 4
				</td>
				<td class="gameAPITable">
					jml9r8bsz1714i
				</td>
				<td>
					<button id="jml9r8bsz1714i1">Create Game as Player 1</button>
				</td>
				<td>
					<button id="jml9r8bsz1714i2">Join Game as Player 2</button>
				</td>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 5
				</td>
				<td class="gameAPITable">
					fuszgluehi8p8pvi
				</td>
				<td>
					<button id="fuszgluehi8p8pvi1">Create Game as Player 1</button>
				</td>
				<td>
					<button id="fuszgluehi8p8pvi2">Join Game as Player 2</button>
				</td>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 6
				</td>
				<td class="gameAPITable">
					dvy4sjbvks79o1or
				</td>
				<td>
					<button id="dvy4sjbvks79o1or1">Create Game as Player 1</button>
				</td>
				<td>
					<button id="dvy4sjbvks79o1or2">Join Game as Player 2</button>
				</td>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 7
				</td>
				<td class="gameAPITable">
					l0wew8sguzo20529
				</td>
				<td>
					<button id="l0wew8sguzo205291">Create Game as Player 1</button>
				</td>
				<td>
					<button id="l0wew8sguzo205292">Join Game as Player 2</button>
				</td>
			</tr>
			<tr>
				<td class="gameNameTable">
					Session 8
				</td>
				<td class="gameAPITable">
					gx8uncxet3s1yvi
				</td>
				<td>
					<button id="gx8uncxet3s1yvi1">Create Game as Player 1</button>
				</td>
				<td>
					<button id="gx8uncxet3s1yvi2">Join Game as Player 2</button>
				</td>
			</tr>
		</table>
	</div>
</body>

</html>